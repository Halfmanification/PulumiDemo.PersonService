name: Deploy Function App

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      azure_functionapp_name:
        type: string
        required: true
      azure_functionapp_package_path:
        type: string
        required: true

jobs:
  deploy-function-app:
    name: Deploy Function App
    environment: ${{ inputs.environment }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        enable-AzPSSession: true
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build source code with Release configuration
      shell: bash
      run: |
        pushd './${{ inputs.azure_functionapp_package_path }}'
        dotnet build --configuration Release --output ./output
        popd
    
    # - name: 'Run Azure Functions Action'
    #   uses: Azure/functions-action@v1 # still on node16, waiting for fix in this PR https://github.com/Azure/functions-action/pull/217
    #   with:
    #     app-name: ${{ inputs.azure_functionapp_name }}
    #     package: '${{ inputs.azure_functionapp_package_path }}/output'

    - name: Deploy Azure Functions (with retry)
      uses: Wandalen/wretry.action@master
      with:
        action: Azure/functions-action@v1 # still on node16, waiting for fix in this PR https://github.com/Azure/functions-action/pull/217
        with: |
          app-name: ${{ inputs.azure_functionapp_name }}
          package: '${{ inputs.azure_functionapp_package_path }}/output'
        attempt_limit: 3
        attempt_delay: 30000
    
    - name: Logout
      run: |
        az logout